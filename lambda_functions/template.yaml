AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'SAM template for DetektivKollektiv API'

Globals:
  Function:
    Timeout: 30
  Api:
    OpenApiVersion: 3.0.1
    
Parameters:
  STAGE:
    Type: String
  CorsAllowOrigin:
    Type: String
  DBNAME:
    Type: String
    Default: development_db
    
Resources:
  Api:
    Type: AWS::Serverless::Api
    Properties:
      StageName: 
        Ref: STAGE
      Cors:
        AllowMethods: "'OPTIONS, PUT, POST, GET'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"

  WhatsappForwardingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-whatsapp_forwarding-${STAGE}'
      CodeUri: .
      Handler: whatsapp.whatsapp_forwarding
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        WhatsappForwarding:
          Type: Api
          Properties:
            Path: /whatsapp_forwarding
            Method: post
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  CreateItemFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-create_item-${STAGE}'
      CodeUri: .
      Handler: app.create_item
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api
          Properties:
            Path: /items
            Method: post
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  GetAllItemsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-get_all_items-${STAGE}'
      CodeUri: .
      Handler: app.get_all_items
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Tracing: Active
      Events:
        Echo:
          Type: Api
          Properties:
            Path: /items
            Method: get
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME
              
  CreateSubmissionFunction:
    Type: AWS::Serverless::Function
    Properties:      
      FunctionName: !Sub 'detektivkollektiv-api-create_submission-${STAGE}'
      CodeUri: .
      Handler: app.create_submission
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api
          Properties:
            Path: /submissions
            Method: post
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  GetAllSubmissionsFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-get_all_submissions-${STAGE}'
      CodeUri: .
      Handler: app.get_all_submissions
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Path: /submissions
            Method: get              
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  GetItemByIdFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-get_item_by_id-${STAGE}'
      CodeUri: .
      Handler: app.get_item_by_id
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Path: /items/{id}
            Method: get              
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  GetItemByContentFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-get_item_by_content-${STAGE}'
      CodeUri: .
      Handler: app.get_item_by_content
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
          - LambdaExecutionRole
          - Arn
      Events:
        Echo:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Path: /items/byContent
            Method: post
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  GetOpenItemsForUserFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-get_open_items_for_user-${STAGE}'
      CodeUri: .
      Handler: app.get_open_items_for_user
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
          - LambdaExecutionRole
          - Arn
      Events:
        Echo:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Auth:
              Authorizer: AWS_IAM
            Path: /open_items_for_user/{num_items}
            Method: get
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME
          CORS_ALLOW_ORIGIN:
            Ref: CorsAllowOrigin

  SearchFactChecksFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-SearchFactChecks-${STAGE}'
      CodeUri: .
      Handler: SearchFactChecks.get_FactChecks
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
          - LambdaExecutionRole
          - Arn

  GetLanguageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-GetLanguage-${STAGE}'
      CodeUri: .
      Handler: GetLanguage.get_language
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
          - LambdaExecutionRole
          - Arn

  GetKeyPhrasesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-GetKeyPhrases-${STAGE}'
      CodeUri: .
      Handler: GetKeyPhrases.get_phrases
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
          - LambdaExecutionRole
          - Arn

  GetEntitiesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-GetEntities-${STAGE}'
      CodeUri: .
      Handler: GetEntities.get_entities
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
          - LambdaExecutionRole
          - Arn

  ExtractClaimFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-ExtractClaim-${STAGE}'
      CodeUri: .
      Handler: ExtractClaim.extract_claim
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
          - LambdaExecutionRole
          - Arn

  GetSentimentFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-GetSentiment-${STAGE}'
      CodeUri: .
      Handler: GetSentiment.get_sentiment
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
          - LambdaExecutionRole
          - Arn

  UpdateLanguageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-UpdateItem-${STAGE}'
      CodeUri: .
      Handler: EnrichItem.update_item
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
          - LambdaExecutionRole
          - Arn

  StoreFactChecksFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-StoreFactChecks-${STAGE}'
      CodeUri: .
      Handler: EnrichItem.store_factchecks
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
          - LambdaExecutionRole
          - Arn

  StoreItemURL:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-StoreItemURL-${STAGE}'
      CodeUri: .
      Handler: EnrichItem.store_itemurl
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
          - LambdaExecutionRole
          - Arn

  CreateUserFunction:
    Type: AWS::Serverless::Function
    Properties:      
      FunctionName: !Sub 'detektivkollektiv-api-create_user-${STAGE}'
      CodeUri: .
      Handler: app.create_user
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api
          Properties:
            Path: /user
            Method: post
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  CreateUserFromCognitoFunction:
    Type: AWS::Serverless::Function
    Properties:      
      FunctionName: !Sub 'detektivkollektiv-api-create_user_from_cognito-${STAGE}'
      CodeUri: .
      Handler: app.create_user_from_cognito
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn      
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  GetAllUsersFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-get_all_users-${STAGE}'
      CodeUri: .
      Handler: app.get_all_users
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Path: /users
            Method: get              
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  GetUserFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-get_user-${STAGE}'
      CodeUri: .
      Handler: app.get_user
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Auth:
              Authorizer: AWS_IAM
            Path: /user
            Method: get              
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME
          CORS_ALLOW_ORIGIN:
            Ref: CorsAllowOrigin

  CreateReviewFunction:
    Type: AWS::Serverless::Function
    Properties:      
      FunctionName: !Sub 'detektivkollektiv-api-create_review-${STAGE}'
      CodeUri: .
      Handler: app.create_review
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api
          Properties:
            Path: /reviews
            Method: post
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  GetAllReviewsFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-get_all_reviews-${STAGE}'
      CodeUri: .
      Handler: app.get_all_reviews
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Path: /reviews
            Method: get              
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  CreateReviewAnswerFunction:
    Type: AWS::Serverless::Function
    Properties:      
      FunctionName: !Sub 'detektivkollektiv-api-create_review_answer-${STAGE}'
      CodeUri: .
      Handler: app.create_review_answer
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api
          Properties:
            Path: /review_answers
            Method: post
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  GetAllReviewAnswersFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-get_all_review_answers-${STAGE}'
      CodeUri: .
      Handler: app.get_all_review_answers
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Path: /review_answers
            Method: get              
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  GetAllReviewQuestionsFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-get_all_review_questions-${STAGE}'
      CodeUri: .
      Handler: app.get_all_review_questions
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Auth:
              Authorizer: AWS_IAM
            Path: /review_questions
            Method: get              
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME
          CORS_ALLOW_ORIGIN:
            Ref: CorsAllowOrigin
      
  ItemSubmissionFunction:
      Type: AWS::Serverless::Function
      Properties:      
        FunctionName: !Sub 'detektivkollektiv-api-item_submission-${STAGE}'
        CodeUri: .
        Handler: app.item_submission
        Runtime: python3.8
        MemorySize: 832
        Role:
          Fn::GetAtt:
          - LambdaExecutionRole
          - Arn
        Events:
          Echo:
            Type: Api
            Properties:
              Auth:
                Authorizer: AWS_IAM
              Path: /item_submission
              Method: post
              RestApiId:
                Ref: Api
        Environment:
          Variables:
            DBNAME:
              Ref: DBNAME
            CORS_ALLOW_ORIGIN:
              Ref: CorsAllowOrigin

  SubmitReviewFunction:
    Type: AWS::Serverless::Function
    Properties:      
      FunctionName: !Sub 'detektivkollektiv-api-submit_review-${STAGE}'
      CodeUri: .
      Handler: app.submit_review
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api
          Properties:
            Auth:
              Authorizer: AWS_IAM
            Path: /submit_review
            Method: post
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME
          CORS_ALLOW_ORIGIN:
            Ref: CorsAllowOrigin
            
  ResetLockedItemsFunction:
    Type: AWS::Serverless::Function
    Properties:      
      FunctionName: !Sub 'detektivkollektiv-api-reset_locked_items-${STAGE}'
      CodeUri: .
      Handler: app.reset_locked_items
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn      
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME

  AcceptItemFunction:
    Type: AWS::Serverless::Function
    Properties:      
      FunctionName: !Sub 'detektivkollektiv-api-accept_item-${STAGE}'
      CodeUri: .
      Handler: app.accept_item
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        Echo:
          Type: Api
          Properties:
            Auth:
              Authorizer: AWS_IAM
            Path: /accept_item/{item_id}
            Method: post
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME
          CORS_ALLOW_ORIGIN:
            Ref: CorsAllowOrigin

  GetAllClosedItemsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub 'detektivkollektiv-api-get_all_closed_items-${STAGE}'
      CodeUri: .
      Handler: app.get_all_closed_items
      Runtime: python3.8
      MemorySize: 832
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Tracing: Active
      Events:
        Echo:
          Type: Api
          Properties:
            Auth:
              Authorizer: AWS_IAM
            Path: /items/closed
            Method: get
            RestApiId:
              Ref: Api
      Environment:
        Variables:
          DBNAME:
            Ref: DBNAME
          CORS_ALLOW_ORIGIN:
            Ref: CorsAllowOrigin

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'detektivkollektiv-api-execution-${STAGE}'
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [lambda.amazonaws.com]
          Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonRDSDataFullAccess
        - arn:aws:iam::aws:policy/SecretsManagerReadWrite
        - arn:aws:iam::aws:policy/ComprehendFullAccess
        